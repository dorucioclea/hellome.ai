// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// =============================================================================
// Issues
// =============================================================================
// `pg_vector` support
// See: https://github.com/prisma/prisma/issues/18442
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Generators
// See: https://www.prisma.io/docs/concepts/components/prisma-schema/generators
// -----------------------------------------------------------------------------

generator docs {
  provider = "node node_modules/prisma-docs-generator"
  output   = "../@gen/doc/prisma"
}

generator erd {
  provider                  = "prisma-erd-generator"
  output                    = "../@gen/erd/ERD.svg"
  theme                     = "default"
  includeRelationFromFields = true
}

generator erd_simple {
  provider  = "prisma-erd-generator"
  output    = "../@gen/erd/ERD.simple.svg"
  theme     = "default"
  tableOnly = true
}

generator zod {
  provider = "zod-prisma-types"
  output   = "../@gen/zod" // default is ./generated/zod
  // useMultipleFiles                 = true  // default is false
  // createInputTypes                 = false // default is true
  // createModelTypes                 = false // default is true
  // addInputTypeValidation           = false // default is true
  // addIncludeType                   = false // default is true
  // addSelectType                    = false // default is true
  // validateWhereUniqueInput         = true  // default is false
  // createOptionalDefaultValuesTypes = true  // default is false
  // createRelationValuesTypes        = true  // default is false
  // createPartialTypes               = true  // default is false
  // useDefaultValidators             = false // default is true
  // coerceDate                       = false // default is true
  // writeNullishInModelTypes         = true  // default is false
}

generator trpc {
  provider                 = "prisma-trpc-generator"
  output                   = "../@gen/trpc"
  // output                   = "../server"
  contextPath              = "../server/context"
  trpcOptionsPath          = "../server/trpcOptions"
  // withMiddleware           = "../server/middlewares/defaultMiddleware"
  withMiddleware           = false
  withZod                  = true
  withShield               = true
  isGenerateSelect         = true
  isGenerateInclude        = true
  showModelNameInProcedure = true

  // generateModelActions = "aggregate,aggregateRaw,count,create,createMany,delete,deleteMany,findFirst,findFirstOrThrow,findMany,findRaw,findUnique,findUniqueOrThrow,groupBy,update,updateMany,upsert"
  // generateModelActions = "create,createMany,findMany,findFirst,delete,deleteMany"
}

generator crud {
  provider = "prisma-next-crud-generator"
  output   = "../@gen/crud"
}

// -----------------------------------------------------------------------------
// Storage
// -----------------------------------------------------------------------------

enum FileResourceType {
  ckpt
  image
  model
  pdf
  safetensor
  video
}

enum FilePrivacy {
  public  @map("public-read")
  private
}

model CloudFile {
  id String @id @default(cuid())

  resourceType FileResourceType @map("resource_type")
  filename     String
  size         Int /// Filesize in bytes @zod.number.positive()
  ext          String /// File extension
  mime         String /// File MIME type
  ///Consolidated embedded metadata associated with the file. It includes exif, iptc, and xmp data.
  metadata     Json?

  // Cloud
  path      String      @unique /// Path on blob store
  signature String      @unique /// Signature on blob store
  privacy   FilePrivacy @default(private) /// Privacy on blob store

  createdAt DateTime @default(now()) @map("created_at")

  photo Photo? // @ ignore
  pdf   PDF? // @ ignore

  // TODO: Add permissions

  @@map("cloud_files")
}

// -----------------------------------------------------------------------------
// User File Types
// -----------------------------------------------------------------------------

model Photo {
  id String @id @default(cuid())

  height    Int      @db.SmallInt /// @zod.number.positive()
  width     Int      @db.SmallInt /// @zod.number.positive()
  tags      String[]
  createdAt DateTime @default(now()) @map("created_at")

  // Web
  // etag String @unique /// Generate via: md5($file.content)-$id
  // url  String @unique /// @zod.string.url()

  fileId       String        @unique @map("file_id") /// @zod.string.cuid()
  file         CloudFile     @relation(fields: [fileId], references: [id]) // TODO: onDelete: Cascade
  pageArtworks PageArtwork[] // @ ignore
  concepts     Concept[] // @ ignore

  @@map("photos")
}

model PDF {
  id String @id @default(cuid())

  height    Int      @db.SmallInt /// @zod.number.positive()
  width     Int      @db.SmallInt /// @zod.number.positive()
  pages     Int      @db.SmallInt /// @zod.number.positive()
  tags      String[]
  createdAt DateTime @default(now()) @map("created_at")

  // Web
  // etag String @unique /// Generate via: md5($file.content)-$id
  // url  String @unique /// @zod.string.url()

  fileId  String    @unique @map("file_id") /// @zod.string.cuid()
  file    CloudFile @relation(fields: [fileId], references: [id]) // TODO: onDelete: Cascade
  edition Edition? // @ ignore

  @@map("pdfs")
}

// -----------------------------------------------------------------------------
// Accounts
// -----------------------------------------------------------------------------

model User {
  id        String   @id @default(cuid())
  /// @zod.string.min(1).max(160)
  name      String
  /// @zod.string.email().min(3).max(160)
  email     String   @unique
  // email     String   @unique @db.Citext()
  updatedAt DateTime @updatedAt @map("updated_at")
  createdAt DateTime @default(now()) @map("created_at")

  // concepts     Concept[]
  Edition Edition[]
  // Concept Concept?

  @@map("users")
}

model Author {
  id String @id @default(cuid())

  stories   Story[]
  pageTexts PageText[]
}

model Artist {
  id String @id @default(cuid())

  stories      Story[]
  pageArtworks PageArtwork[]
}

model Translator {
  id String @id @default(cuid())

  pageTexts PageText[]
}

// -----------------------------------------------------------------------------
// Locales
// -----------------------------------------------------------------------------

enum Locale {
  en_US
  en
}

// -----------------------------------------------------------------------------
// Stories
// -----------------------------------------------------------------------------

model Story {
  id String @id @default(cuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  artistId     String?       @map("artist_id") /// @zod.string.cuid()
  authorId     String?       @map("author_id") /// @zod.string.cuid()
  artist       Artist?       @relation(fields: [artistId], references: [id], onDelete: Cascade)
  author       Author?       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  pages        Page[]
  pageArtworks PageArtwork[]
  pageTexts    PageText[]

  @@index([artistId], name: "Story_artistId")
  @@index([authorId], name: "Story_authorId")
  @@map("stories")
}

enum PageStatus {
  DRAFT
  PUBLISHED
}

enum PageType {
  FrontCover
  Body
  BackCover
}

enum PageArtworkType {
  machine_generated
  user_creative_work
  user_scribble
}

enum PageTextType {
  machine_generated
  machine_translated
  user_creative_work
  user_translated
}

model PageArtwork {
  id String @id @default(cuid())

  status    PageStatus @default(DRAFT)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  pageId   String @map("page_id") /// @zod.string.cuid()
  storyId  String @map("story_id") /// @zod.string.cuid()
  artistId String @map("artist_id") /// @zod.string.cuid()
  photoId  String @map("photo_id") /// @zod.string.cuid()
  page     Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)
  story    Story  @relation(fields: [storyId], references: [id], onDelete: Cascade)
  artist   Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)
  photo    Photo  @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@index([pageId], name: "PageArtwork_pageId")
  @@map("page_artworks")
}

model PageText {
  id String @id @default(cuid())

  status    PageStatus   @default(DRAFT)
  locale    Locale
  text      String /// @zod.string.min(1).max(5000)
  type      PageTextType
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  pageId       String      @map("page_id") /// @zod.string.cuid()
  storyId      String      @map("story_id") /// @zod.string.cuid()
  authorId     String?     @map("author_id") /// @zod.string.cuid()
  translatorId String?     @map("translator_id") /// @zod.string.cuid()
  page         Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
  story        Story       @relation(fields: [storyId], references: [id], onDelete: Cascade)
  author       Author?     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  translator   Translator? @relation(fields: [translatorId], references: [id])

  @@index([pageId], name: "PageText_pageId")
  @@map("page_texts")
}

model Page {
  id String @id @default(cuid())

  status     PageStatus @default(DRAFT)
  type       PageType
  pageNumber Int        @map("page_number") @db.SmallInt() /// @zod.number.gte(1).lte(100)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  storyId  String        @map("story_id") /// @zod.string.cuid()
  story    Story         @relation(fields: [storyId], references: [id], onDelete: Cascade)
  artworks PageArtwork[]
  texts    PageText[]

  @@index([storyId], name: "Page_storyId")
  @@map("pages")
}

// -----------------------------------------------------------------------------
// Editions
// -----------------------------------------------------------------------------

model Edition {
  id String @id @default(cuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userId String @unique @map("user_id") /// @zod.string.cuid()
  pdfId  String @unique @map("pdf_id") /// @zod.string.cuid()
  user   User   @relation(fields: [userId], references: [id])
  pdf    PDF    @relation(fields: [pdfId], references: [id])

  @@index([userId], name: "Edition_userId")
  @@map("editions")
}

// -----------------------------------------------------------------------------
// Concepts
// -----------------------------------------------------------------------------

enum ConceptType {
  person
  place
  thing
}

model Concept {
  id          String      @id @default(cuid())
  name        String /// @zod.string.min(1).max(100
  type        ConceptType
  description String?
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // userId String? @unique @map("user_id") /// @zod.string.cuid()
  // user   User?   @relation(fields: [userId], references: [id])

  photos Photo[]

  // @@index([userId], name: "Concept_userId")
  @@map("concepts")
}

// -----------------------------------------------------------------------------
// DreamBooth Prediction
// -----------------------------------------------------------------------------

model Prediction {
  id           String    @id @default(cuid())
  uuid         String    @unique
  input        Json?
  output       Json?
  status       String?
  created_at   DateTime?
  started_at   DateTime?
  completed_at DateTime?
  version      String?
  metrics      Json?
  error        String?
  logs         String?   @db.Text

  @@map(name: "predictions")
}
